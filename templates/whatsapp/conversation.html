{% extends "base.html" %}

{% block title %}Conversación | WhatsApp{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='whatsapp.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center gap-2 mb-3">
    <a href="{{ url_for('whatsapp_dashboard') }}" class="btn btn-link ps-0">&larr; Volver</a>
    <button class="btn btn-outline-success btn-sm" type="button" id="refresh-messages">
        <i class="fas fa-sync-alt"></i> Refrescar
    </button>
</div>

<div class="card shadow-sm conversation-card">
    <div class="card-header">
        <h2 class="h5 mb-0">{{ conversation.contact_name or conversation.contact_number|chat_display }}</h2>
        <small class="text-muted" id="conversation-updated">
            Última actualización: {{ conversation.updated_at.strftime("%d/%m/%Y %H:%M") if conversation.updated_at else "N/D" }}
        </small>
    </div>
    <div
        class="card-body conversation-thread"
        id="conversation-thread"
        data-conversation-id="{{ conversation.id }}"
        data-fetch-url="{{ url_for('whatsapp_api_conversation_messages', conversation_id=conversation.id) }}"
        data-last-id="{{ (messages|last).id if messages else 0 }}"
        data-contact-name="{{ conversation.contact_name or conversation.contact_number|chat_display }}"
    >
        {% if messages %}
            {% set contact_label = conversation.contact_name or conversation.contact_number|chat_display %}
            {% for message in messages %}
                <div class="message-bubble {% if message.sender_type == 'agent' %}message-agent{% else %}message-customer{% endif %}">
                    <div class="message-meta">
                        {% if message.sender_type == 'agent' %}
                            {% if message.usuario %}
                                <span class="badge" style="background-color: {{ message.usuario.color or '#007bff' }}; color: white;">
                                    {{ message.usuario.username }}
                                </span>
                            {% else %}
                                <span class="badge bg-primary">Sistema</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-success">{{ contact_label }}</span>
                        {% endif %}
                        <small class="text-muted">{{ message.sent_at.strftime("%d/%m/%Y %H:%M") if message.sent_at else "" }}</small>
                    </div>
                    <div class="message-content">
                        {% if message.media_type %}
                            {% if message.media_url or message.external_id %}
                                {% set media_route = url_for('whatsapp_media', message_id=message.id) %}
                                {% if message.media_type == 'imagen' %}
                                    <a href="{{ media_route }}" target="_blank" rel="noopener" download class="media-link">
                                        <img src="{{ media_route }}" alt="Imagen recibida" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display:none;" class="attachment-chip">
                                            <i class="fas fa-image"></i>
                                            <a href="{{ media_route }}" target="_blank" rel="noopener" download>Ver/Descargar imagen</a>
                                        </div>
                                    </a>
                                {% elif message.media_type == 'video' %}
                                    <video controls class="media-preview video-preview">
                                        <source src="{{ media_route }}">
                                        Tu navegador no soporta video.
                                    </video>
                                    <div><a href="{{ media_route }}" target="_blank" rel="noopener" download>Descargar video</a></div>
                                {% elif message.media_type == 'audio' %}
                                    <audio controls class="audio-player">
                                        <source src="{{ media_route }}">
                                        Tu navegador no soporta audio.
                                    </audio>
                                    <div><a href="{{ media_route }}" target="_blank" rel="noopener" download>Descargar audio</a></div>
                                {% else %}
                                    <div class="attachment-chip">
                                        <i class="fas fa-paperclip"></i>
                                        <a href="{{ media_route }}" target="_blank" rel="noopener" download>Descargar archivo</a>
                                    </div>
                                {% endif %}
                            {% else %}
                                {# Si hay media_type pero no hay URL ni external_id, mostrar un indicador #}
                                <div class="attachment-chip">
                                    <i class="fas fa-image"></i> Imagen (no disponible)
                                </div>
                            {% endif %}
                        {% endif %}
                        {% if message.message_text and message.message_text != '[Imagen]' %}
                            <div class="message-text">{{ message.message_text | nl2br }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted text-center">No hay mensajes en esta conversación.</p>
        {% endif %}
    </div>
    <div class="card-footer">
        <form method="post" class="d-flex gap-2 flex-wrap" id="message-form">
            <textarea
                name="message"
                class="form-control"
                rows="2"
                placeholder="Escribe tu respuesta..."
                required
                id="message-input"
            ></textarea>
            <div class="d-flex flex-column align-items-end gap-2">
                <button class="btn btn-success" type="submit">Enviar</button>
                <div id="send-feedback" class="small text-success d-none"></div>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const thread = document.getElementById("conversation-thread");
    if (!thread) {
        return;
    }

    const fetchUrl = thread.dataset.fetchUrl;
    let lastId = Number(thread.dataset.lastId || 0);
    const updatedLabel = document.getElementById("conversation-updated");
    const contactLabel = thread.dataset.contactName || "Cliente";

    function buildMediaContent(container, msg) {
        // Mostrar media si hay media_type y (media_route, media_url o external_id)
        if (msg.media_type && (msg.media_route || msg.media_url || msg.external_id)) {
            const mediaWrapper = document.createElement("div");
            mediaWrapper.className = "message-media";
            // Preferir media_route (generado por el servidor), luego media_url, luego construir desde external_id
            const sourceUrl = msg.media_route || msg.media_url || (msg.external_id ? `/whatsapp/media/${msg.id}` : null);

            switch (msg.media_type) {
                case "imagen":
                    const imgLink = document.createElement("a");
                    imgLink.href = sourceUrl;
                    imgLink.target = "_blank";
                    imgLink.rel = "noopener";
                    imgLink.download = "";
                    imgLink.className = "media-link";
                    const img = document.createElement("img");
                    img.src = sourceUrl;
                    img.alt = "Imagen recibida";
                    img.className = "media-preview";
                    img.onerror = function() {
                        // Si la imagen falla al cargar, mostrar un enlace de descarga
                        img.style.display = 'none';
                        const fallback = document.createElement("div");
                        fallback.className = "attachment-chip";
                        fallback.innerHTML = `<i class="fas fa-image"></i> <a href="${sourceUrl}" target="_blank" rel="noopener" download>Ver/Descargar imagen</a>`;
                        imgLink.appendChild(fallback);
                    };
                    imgLink.appendChild(img);
                    mediaWrapper.appendChild(imgLink);
                    break;
                case "video":
                    const video = document.createElement("video");
                    video.controls = true;
                    video.className = "media-preview video-preview";
                    const videoSource = document.createElement("source");
                    videoSource.src = sourceUrl;
                    video.appendChild(videoSource);
                    mediaWrapper.appendChild(video);
                    const videoDownload = document.createElement("div");
                    videoDownload.innerHTML = `<a href="${sourceUrl}" target="_blank" rel="noopener" download>Descargar video</a>`;
                    mediaWrapper.appendChild(videoDownload);
                    break;
                case "audio":
                    const audio = document.createElement("audio");
                    audio.controls = true;
                    audio.className = "audio-player";
                    const audioSource = document.createElement("source");
                    audioSource.src = sourceUrl;
                    audio.appendChild(audioSource);
                    mediaWrapper.appendChild(audio);
                    const audioDownload = document.createElement("div");
                    audioDownload.innerHTML = `<a href="${sourceUrl}" target="_blank" rel="noopener" download>Descargar audio</a>`;
                    mediaWrapper.appendChild(audioDownload);
                    break;
                default:
                    const chip = document.createElement("div");
                    chip.className = "attachment-chip";
                    chip.innerHTML = `<i class="fas fa-paperclip"></i> <a href="${sourceUrl}" target="_blank" rel="noopener" download>Descargar archivo</a>`;
                    mediaWrapper.appendChild(chip);
                    break;
            }

            container.appendChild(mediaWrapper);
        }
    }

    function appendMessage(msg) {
        const bubble = document.createElement("div");
        bubble.className = "message-bubble " + (msg.sender_type === "agent" ? "message-agent" : "message-customer");

        const meta = document.createElement("div");
        meta.className = "message-meta";

        const badge = document.createElement("span");
        if (msg.sender_type === "agent") {
            if (msg.usuario && msg.usuario.username) {
                badge.className = "badge";
                badge.style.backgroundColor = msg.usuario.color || "#007bff";
                badge.style.color = "white";
                badge.textContent = msg.usuario.username;
            } else {
                badge.className = "badge bg-primary";
                badge.textContent = "Sistema";
            }
        } else {
            badge.className = "badge bg-success";
            badge.textContent = contactLabel;
        }

        const timestamp = document.createElement("small");
        timestamp.className = "text-muted";
        timestamp.textContent = msg.sent_at_human;

        meta.appendChild(badge);
        meta.appendChild(timestamp);
        bubble.appendChild(meta);

        const content = document.createElement("div");
        content.className = "message-content";

        buildMediaContent(content, msg);

        // Mostrar texto solo si existe y no es el placeholder de imagen
        if (msg.message_text && msg.message_text !== '[Imagen]') {
            const text = document.createElement("div");
            text.className = "message-text";
            text.textContent = msg.message_text;
            content.appendChild(text);
        }
        
        // Si hay media pero no hay contenido visible, añadir un indicador
        if (msg.media_type && content.children.length === 0) {
            const indicator = document.createElement("div");
            indicator.className = "text-muted small";
            indicator.textContent = `[${msg.media_type}]`;
            content.appendChild(indicator);
        }

        bubble.appendChild(content);
        thread.appendChild(bubble);
        thread.scrollTop = thread.scrollHeight;
    }

    function fetchMessages() {
        const url = new URL(fetchUrl, window.location.origin);
        url.searchParams.set("after_id", lastId);
        url.searchParams.set("mark_read", "1");

        fetch(url)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Error al actualizar la conversación");
                }
                return response.json();
            })
            .then((payload) => {
                if (Array.isArray(payload.messages) && payload.messages.length > 0) {
                    payload.messages.forEach((message) => {
                        appendMessage(message);
                        lastId = Math.max(lastId, message.id);
                    });
                    thread.dataset.lastId = String(lastId);
                }
                if (payload.updated_at_human && updatedLabel) {
                    updatedLabel.textContent = "Última actualización: " + payload.updated_at_human;
                }
            })
            .catch((error) => {
                console.error(error);
            });
    }

    setInterval(fetchMessages, 5000);

    const form = document.getElementById("message-form");
    const textarea = document.getElementById("message-input");
    const feedback = document.getElementById("send-feedback");

    if (form && textarea) {
        textarea.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                form.requestSubmit();
            }
        });

        form.addEventListener("submit", function() {
            if (feedback) {
                feedback.classList.add("d-none");
                feedback.classList.remove("text-danger", "text-success");
                feedback.textContent = "";
            }
        });
    }

    const refreshBtn = document.getElementById("refresh-messages");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            fetchMessages();
        });
    }

    if (feedback) {
        const successFlash = document.querySelector(".alert-success");
        const errorFlash = document.querySelector(".alert-danger");

        if (successFlash) {
            feedback.textContent = successFlash.textContent.trim();
            feedback.classList.remove("d-none", "text-danger");
            feedback.classList.add("text-success");
            successFlash.remove();
        } else if (errorFlash) {
            feedback.textContent = errorFlash.textContent.trim();
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            errorFlash.remove();
        }

        if (!feedback.classList.contains("d-none")) {
            setTimeout(() => {
                feedback.classList.add("d-none");
            }, 4000);
        }
    }

    thread.scrollTop = thread.scrollHeight;
})();
</script>
{% endblock %}
