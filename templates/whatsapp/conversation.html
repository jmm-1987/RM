{% extends "base.html" %}

{% block title %}Conversación | WhatsApp{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='whatsapp.css') }}">
{% endblock %}

{% block content %}
<div class="card shadow-sm conversation-card">
    <div class="card-header" style="position: relative; background: linear-gradient(135deg, #1f8a70, #155f4b) !important;">
        <!-- Botones dentro del header -->
        <div class="d-flex justify-content-between align-items-center gap-2 mb-2" style="width: 100%; flex-wrap: nowrap;">
            <a href="{{ url_for('whatsapp_dashboard') }}" class="btn btn-sm" style="background: rgba(255, 255, 255, 0.25) !important; color: #fff !important; border: 1px solid rgba(255, 255, 255, 0.4) !important; text-decoration: none !important; padding: 0.4rem 0.8rem; border-radius: 6px; white-space: nowrap;">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            <button class="btn btn-outline-light btn-sm" type="button" id="refresh-messages" style="border-color: rgba(255, 255, 255, 0.6) !important; color: #fff !important; border-radius: 6px; white-space: nowrap;">
                <i class="fas fa-sync-alt"></i> Refrescar
            </button>
        </div>
        <!-- Nombre y última actualización en la misma línea -->
        <div class="d-flex align-items-center gap-2 flex-wrap" style="width: 100%;">
            <h2 class="h5 mb-0" style="color: #fff !important; margin: 0;">{{ conversation.contact_name or conversation.contact_number|chat_display }}</h2>
            <small class="text-light" id="conversation-updated" style="color: rgba(255, 255, 255, 0.9) !important; margin: 0;">
                Última actualización: {{ (conversation.updated_at | local_time).strftime("%d/%m/%Y %H:%M") if conversation.updated_at else "N/D" }}
            </small>
        </div>
    </div>
    <div
        class="card-body conversation-thread"
        id="conversation-thread"
        data-conversation-id="{{ conversation.id }}"
        data-fetch-url="{{ url_for('whatsapp_api_conversation_messages', conversation_id=conversation.id) }}"
        data-last-id="{{ (messages|last).id if messages else 0 }}"
        data-contact-name="{{ conversation.contact_name or conversation.contact_number|chat_display }}"
    >
        {% if messages %}
            {% set contact_label = conversation.contact_name or conversation.contact_number|chat_display %}
            {% for message in messages %}
                <div class="message-bubble {% if message.sender_type == 'agent' %}message-agent{% else %}message-customer{% endif %}">
                    <div class="message-meta">
                        {% if message.sender_type == 'agent' %}
                            {% if message.usuario %}
                                <span class="badge" style="background-color: {{ message.usuario.color or '#007bff' }}; color: white;">
                                    {{ message.usuario.username }}
                                </span>
                            {% else %}
                                <span class="badge bg-primary">Sistema</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-success">{{ contact_label }}</span>
                        {% endif %}
                        <small class="text-muted" style="color: {% if message.sender_type == 'agent' %}rgba(255, 255, 255, 0.9){% else %}#6c757d{% endif %} !important;">{{ (message.sent_at | local_time).strftime("%d/%m/%Y %H:%M") if message.sent_at else "" }}</small>
                    </div>
                    <div class="message-content">
                        {% if message.media_type %}
                            {% set media_route = url_for('whatsapp_media', message_id=message.id) %}
                            {% if message.media_type == 'imagen' %}
                                <div class="media-thumbnail-wrapper">
                                    <a href="{{ media_route }}" target="_blank" rel="noopener" class="media-link" title="Haz clic para ver imagen completa">
                                        <img src="{{ media_route }}" alt="Imagen" class="media-preview" style="width: 400px; height: 300px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display:none;" class="attachment-chip">
                                            <i class="fas fa-image"></i>
                                            <a href="{{ media_route }}" target="_blank" rel="noopener" download>Ver/Descargar imagen</a>
                                        </div>
                                    </a>
                                    <small class="media-indicator" style="display: block; margin-top: 4px; opacity: 0.7;">
                                        <i class="fas fa-image"></i> Imagen
                                    </small>
                                </div>
                            {% elif message.media_type == 'video' %}
                                <video controls class="media-preview video-preview">
                                    <source src="{{ media_route }}">
                                    Tu navegador no soporta video.
                                </video>
                                <div><a href="{{ media_route }}" target="_blank" rel="noopener" download style="color: {% if message.sender_type == 'agent' %}#fff{% else %}#1f8a70{% endif %};">Descargar video</a></div>
                            {% elif message.media_type == 'audio' %}
                                <audio controls class="audio-player">
                                    <source src="{{ media_route }}">
                                    Tu navegador no soporta audio.
                                </audio>
                                <div><a href="{{ media_route }}" target="_blank" rel="noopener" download style="color: {% if message.sender_type == 'agent' %}#fff{% else %}#1f8a70{% endif %};">Descargar audio</a></div>
                            {% else %}
                                <div class="attachment-chip">
                                    <i class="fas fa-paperclip"></i>
                                    <a href="{{ media_route }}" target="_blank" rel="noopener" download>Descargar archivo</a>
                                </div>
                            {% endif %}
                        {% endif %}
                        {% if message.message_text and message.message_text != '[Imagen]' %}
                            <div class="message-text">{{ message.message_text | nl2br }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center" style="color: rgba(255, 255, 255, 0.7);">No hay mensajes en esta conversación.</p>
        {% endif %}
    </div>
    <div class="card-footer">
        <form method="post" enctype="multipart/form-data" class="d-flex gap-2 flex-wrap" id="message-form">
            <div class="flex-grow-1 d-flex flex-column gap-2">
                <div id="image-preview-container" class="d-none mb-2">
                    <div class="position-relative d-inline-block">
                        <img id="image-preview" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #28a745;">
                        <button type="button" id="remove-image-btn" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" style="border-radius: 50%; width: 24px; height: 24px; padding: 0; line-height: 1;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <textarea
                        name="message"
                        class="form-control"
                        rows="2"
                        placeholder="Escribe tu respuesta..."
                        id="message-input"
                    ></textarea>
                    <div class="d-flex flex-column gap-2">
                        <label for="image-input" class="btn btn-outline-primary mb-0" style="cursor: pointer;" title="Adjuntar imagen">
                            <i class="fas fa-image"></i>
                        </label>
                        <input type="file" id="image-input" name="image" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
                <button class="btn btn-success" type="submit" id="send-btn">Enviar</button>
                <div id="send-feedback" class="small text-success d-none"></div>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const thread = document.getElementById("conversation-thread");
    if (!thread) {
        return;
    }

    const fetchUrl = thread.dataset.fetchUrl;
    let lastId = Number(thread.dataset.lastId || 0);
    const updatedLabel = document.getElementById("conversation-updated");
    const contactLabel = thread.dataset.contactName || "Cliente";

    function buildMediaContent(container, msg) {
        // Mostrar media si hay media_type (siempre intentar mostrar, incluso sin URL guardada)
        if (msg.media_type) {
            const mediaWrapper = document.createElement("div");
            mediaWrapper.className = "message-media";
            // Preferir media_route (generado por el servidor), luego media_url, luego construir desde external_id o message_id
            const sourceUrl = msg.media_route || msg.media_url || (msg.external_id ? `/whatsapp/media/${msg.id}` : `/whatsapp/media/${msg.id}`);

            switch (msg.media_type) {
                case "imagen":
                    const thumbnailWrapper = document.createElement("div");
                    thumbnailWrapper.className = "media-thumbnail-wrapper";
                    
                    const imgLink = document.createElement("a");
                    imgLink.href = sourceUrl;
                    imgLink.target = "_blank";
                    imgLink.rel = "noopener";
                    imgLink.className = "media-link";
                    imgLink.title = "Haz clic para ver imagen completa";
                    
                    const img = document.createElement("img");
                    img.src = sourceUrl;
                    img.alt = "Imagen";
                    img.className = "media-preview";
                    img.style.width = "400px";
                    img.style.height = "300px";
                    img.style.objectFit = "contain";
                    img.onerror = function() {
                        // Si la imagen falla al cargar, mostrar un enlace de descarga
                        img.style.display = 'none';
                        const fallback = document.createElement("div");
                        fallback.className = "attachment-chip";
                        fallback.innerHTML = `<i class="fas fa-image"></i> <a href="${sourceUrl}" target="_blank" rel="noopener" download>Ver/Descargar imagen</a>`;
                        imgLink.appendChild(fallback);
                    };
                    imgLink.appendChild(img);
                    
                    const indicator = document.createElement("small");
                    indicator.className = "media-indicator";
                    indicator.style.display = "block";
                    indicator.style.marginTop = "4px";
                    indicator.style.opacity = "0.7";
                    indicator.innerHTML = '<i class="fas fa-image"></i> Imagen';
                    if (msg.sender_type === "customer") {
                        indicator.style.color = "rgba(0, 0, 0, 0.6)";
                    }
                    
                    thumbnailWrapper.appendChild(imgLink);
                    thumbnailWrapper.appendChild(indicator);
                    mediaWrapper.appendChild(thumbnailWrapper);
                    break;
                case "video":
                    const video = document.createElement("video");
                    video.controls = true;
                    video.className = "media-preview video-preview";
                    const videoSource = document.createElement("source");
                    videoSource.src = sourceUrl;
                    video.appendChild(videoSource);
                    mediaWrapper.appendChild(video);
                    const videoDownload = document.createElement("div");
                    const videoLink = document.createElement("a");
                    videoLink.href = sourceUrl;
                    videoLink.target = "_blank";
                    videoLink.rel = "noopener";
                    videoLink.download = "";
                    videoLink.textContent = "Descargar video";
                    videoLink.style.color = msg.sender_type === "agent" ? "#fff" : "#1f8a70";
                    videoDownload.appendChild(videoLink);
                    mediaWrapper.appendChild(videoDownload);
                    break;
                case "audio":
                    const audio = document.createElement("audio");
                    audio.controls = true;
                    audio.className = "audio-player";
                    const audioSource = document.createElement("source");
                    audioSource.src = sourceUrl;
                    audio.appendChild(audioSource);
                    mediaWrapper.appendChild(audio);
                    const audioDownload = document.createElement("div");
                    const audioLink = document.createElement("a");
                    audioLink.href = sourceUrl;
                    audioLink.target = "_blank";
                    audioLink.rel = "noopener";
                    audioLink.download = "";
                    audioLink.textContent = "Descargar audio";
                    audioLink.style.color = msg.sender_type === "agent" ? "#fff" : "#1f8a70";
                    audioDownload.appendChild(audioLink);
                    mediaWrapper.appendChild(audioDownload);
                    break;
                default:
                    const chip = document.createElement("div");
                    chip.className = "attachment-chip";
                    chip.innerHTML = `<i class="fas fa-paperclip"></i> <a href="${sourceUrl}" target="_blank" rel="noopener" download>Descargar archivo</a>`;
                    mediaWrapper.appendChild(chip);
                    break;
            }

            container.appendChild(mediaWrapper);
        }
    }

    function appendMessage(msg) {
        const bubble = document.createElement("div");
        bubble.className = "message-bubble " + (msg.sender_type === "agent" ? "message-agent" : "message-customer");

        const meta = document.createElement("div");
        meta.className = "message-meta";

        const badge = document.createElement("span");
        if (msg.sender_type === "agent") {
            if (msg.usuario && msg.usuario.username) {
                badge.className = "badge";
                badge.style.backgroundColor = msg.usuario.color || "#007bff";
                badge.style.color = "white";
                badge.textContent = msg.usuario.username;
            } else {
                badge.className = "badge bg-primary";
                badge.textContent = "Sistema";
            }
        } else {
            badge.className = "badge bg-success";
            badge.textContent = contactLabel;
        }

        const timestamp = document.createElement("small");
        timestamp.className = "text-muted";
        timestamp.style.color = msg.sender_type === "agent" ? "rgba(255, 255, 255, 0.9)" : "#6c757d";
        timestamp.textContent = msg.sent_at_human;

        meta.appendChild(badge);
        meta.appendChild(timestamp);
        bubble.appendChild(meta);

        const content = document.createElement("div");
        content.className = "message-content";

        buildMediaContent(content, msg);

        // Mostrar texto solo si existe y no es el placeholder de imagen
        if (msg.message_text && msg.message_text !== '[Imagen]') {
            const text = document.createElement("div");
            text.className = "message-text";
            text.textContent = msg.message_text;
            content.appendChild(text);
        }
        
        // Si hay media pero no hay contenido visible, añadir un indicador
        if (msg.media_type && content.children.length === 0) {
            const indicator = document.createElement("div");
            indicator.className = "text-muted small";
            indicator.textContent = `[${msg.media_type}]`;
            content.appendChild(indicator);
        }

        bubble.appendChild(content);
        thread.appendChild(bubble);
        thread.scrollTop = thread.scrollHeight;
    }

    function fetchMessages() {
        const url = new URL(fetchUrl, window.location.origin);
        url.searchParams.set("after_id", lastId);
        url.searchParams.set("mark_read", "1");

        fetch(url)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Error al actualizar la conversación");
                }
                return response.json();
            })
            .then((payload) => {
                if (Array.isArray(payload.messages) && payload.messages.length > 0) {
                    payload.messages.forEach((message) => {
                        appendMessage(message);
                        lastId = Math.max(lastId, message.id);
                    });
                    thread.dataset.lastId = String(lastId);
                }
                if (payload.updated_at_human && updatedLabel) {
                    updatedLabel.textContent = "Última actualización: " + payload.updated_at_human;
                    updatedLabel.style.color = "rgba(255, 255, 255, 0.9)"; // Mantener color blanco
                }
            })
            .catch((error) => {
                console.error(error);
            });
    }

    setInterval(fetchMessages, 10000); // Reducido de 5s a 10s para mejor rendimiento

    const form = document.getElementById("message-form");
    const textarea = document.getElementById("message-input");
    const feedback = document.getElementById("send-feedback");
    const imageInput = document.getElementById("image-input");
    const imagePreview = document.getElementById("image-preview");
    const imagePreviewContainer = document.getElementById("image-preview-container");
    const removeImageBtn = document.getElementById("remove-image-btn");
    const sendBtn = document.getElementById("send-btn");

    // Manejar selección de imagen
    if (imageInput) {
        imageInput.addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                // Validar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen válido');
                    imageInput.value = '';
                    return;
                }

                // Validar tamaño (máximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. Máximo 5MB');
                    imageInput.value = '';
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove("d-none");
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Manejar eliminación de imagen
    if (removeImageBtn) {
        removeImageBtn.addEventListener("click", function() {
            if (imageInput) {
                imageInput.value = '';
            }
            if (imagePreview) {
                imagePreview.src = '';
            }
            if (imagePreviewContainer) {
                imagePreviewContainer.classList.add("d-none");
            }
        });
    }

    if (form && textarea) {
        textarea.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                form.requestSubmit();
            }
        });

        form.addEventListener("submit", function(event) {
            // Validar que haya mensaje o imagen
            const hasMessage = textarea.value.trim().length > 0;
            const hasImage = imageInput && imageInput.files.length > 0;

            if (!hasMessage && !hasImage) {
                event.preventDefault();
                alert('Debes escribir un mensaje o adjuntar una imagen');
                return false;
            }

            // Remover el atributo required del textarea si hay imagen
            if (hasImage && !hasMessage) {
                textarea.removeAttribute('required');
            }

            if (feedback) {
                feedback.classList.add("d-none");
                feedback.classList.remove("text-danger", "text-success");
                feedback.textContent = "";
            }
        });
    }

    const refreshBtn = document.getElementById("refresh-messages");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            fetchMessages();
        });
    }

    if (feedback) {
        const successFlash = document.querySelector(".alert-success");
        const errorFlash = document.querySelector(".alert-danger");

        if (successFlash) {
            feedback.textContent = successFlash.textContent.trim();
            feedback.classList.remove("d-none", "text-danger");
            feedback.classList.add("text-success");
            successFlash.remove();
        } else if (errorFlash) {
            feedback.textContent = errorFlash.textContent.trim();
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            errorFlash.remove();
        }

        if (!feedback.classList.contains("d-none")) {
            setTimeout(() => {
                feedback.classList.add("d-none");
            }, 4000);
        }
    }

    thread.scrollTop = thread.scrollHeight;
})();
</script>
{% endblock %}
