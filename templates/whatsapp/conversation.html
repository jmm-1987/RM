{% extends "base.html" %}

{% block title %}Conversación | WhatsApp{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='whatsapp.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center gap-2 mb-3">
    <a href="{{ url_for('whatsapp_dashboard') }}" class="btn btn-link ps-0">&larr; Volver</a>
    <button class="btn btn-outline-success btn-sm" type="button" id="refresh-messages">
        <i class="fas fa-sync-alt"></i> Refrescar
    </button>
</div>

<div class="card shadow-sm conversation-card">
    <div class="card-header">
        <h2 class="h5 mb-0">{{ conversation.contact_name or conversation.contact_number|chat_display }}</h2>
        <small class="text-muted" id="conversation-updated">
            Última actualización: {{ conversation.updated_at.strftime("%d/%m/%Y %H:%M") if conversation.updated_at else "N/D" }}
        </small>
    </div>
    <div
        class="card-body conversation-thread"
        id="conversation-thread"
        data-conversation-id="{{ conversation.id }}"
        data-fetch-url="{{ url_for('whatsapp_api_conversation_messages', conversation_id=conversation.id) }}"
        data-last-id="{{ (messages|last).id if messages else 0 }}"
        data-contact-name="{{ conversation.contact_name or conversation.contact_number|chat_display }}"
    >
        {% if messages %}
            {% set contact_label = conversation.contact_name or conversation.contact_number|chat_display %}
            {% for message in messages %}
                <div class="message-bubble {% if message.sender_type == 'agent' %}message-agent{% else %}message-customer{% endif %}">
                    <div class="message-meta">
                        {% if message.sender_type == 'agent' %}
                            <span class="badge bg-primary">Tú</span>
                        {% else %}
                            <span class="badge bg-success">{{ contact_label }}</span>
                        {% endif %}
                        <small class="text-muted">{{ message.sent_at.strftime("%d/%m/%Y %H:%M") if message.sent_at else "" }}</small>
                    </div>
                    <div class="message-content">
                        {% if message.media_type and message.media_url %}
                            {% if message.media_type == 'imagen' %}
                                <a href="{{ message.media_url }}" target="_blank" rel="noopener" download class="media-link">
                                    <img src="{{ message.media_url }}" alt="Imagen recibida" class="media-preview">
                                </a>
                            {% elif message.media_type == 'video' %}
                                <video controls class="media-preview video-preview">
                                    <source src="{{ message.media_url }}">
                                    Tu navegador no soporta video.
                                </video>
                                <div><a href="{{ message.media_url }}" target="_blank" rel="noopener" download>Descargar video</a></div>
                            {% elif message.media_type == 'audio' %}
                                <audio controls class="audio-player">
                                    <source src="{{ message.media_url }}">
                                    Tu navegador no soporta audio.
                                </audio>
                                <div><a href="{{ message.media_url }}" target="_blank" rel="noopener" download>Descargar audio</a></div>
                            {% else %}
                                <div class="attachment-chip">
                                    <i class="fas fa-paperclip"></i>
                                    <a href="{{ message.media_url }}" target="_blank" rel="noopener" download>Descargar archivo</a>
                                </div>
                            {% endif %}
                        {% endif %}
                        {% if message.message_text %}
                            <div class="message-text">{{ message.message_text | nl2br }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted text-center">No hay mensajes en esta conversación.</p>
        {% endif %}
    </div>
    <div class="card-footer">
        <form method="post" class="d-flex gap-2" id="message-form">
            <textarea
                name="message"
                class="form-control"
                rows="2"
                placeholder="Escribe tu respuesta..."
                required
                id="message-input"
            ></textarea>
            <button class="btn btn-success" type="submit">Enviar</button>
        </form>
    </div>
</div>

<script>
(function() {
    const thread = document.getElementById("conversation-thread");
    if (!thread) {
        return;
    }

    const fetchUrl = thread.dataset.fetchUrl;
    let lastId = Number(thread.dataset.lastId || 0);
    const updatedLabel = document.getElementById("conversation-updated");
    const contactLabel = thread.dataset.contactName || "Cliente";

    function buildMediaContent(container, msg) {
        if (msg.media_type && msg.media_url) {
            const mediaWrapper = document.createElement("div");
            mediaWrapper.className = "message-media";

            switch (msg.media_type) {
                case "imagen":
                    const imgLink = document.createElement("a");
                    imgLink.href = msg.media_url;
                    imgLink.target = "_blank";
                    imgLink.rel = "noopener";
                    imgLink.download = "";
                    const img = document.createElement("img");
                    img.src = msg.media_url;
                    img.alt = "Imagen recibida";
                    img.className = "media-preview";
                    imgLink.appendChild(img);
                    mediaWrapper.appendChild(imgLink);
                    break;
                case "video":
                    const video = document.createElement("video");
                    video.controls = true;
                    video.className = "media-preview video-preview";
                    const videoSource = document.createElement("source");
                    videoSource.src = msg.media_url;
                    video.appendChild(videoSource);
                    mediaWrapper.appendChild(video);
                    const videoDownload = document.createElement("div");
                    videoDownload.innerHTML = `<a href="${msg.media_url}" target="_blank" rel="noopener" download>Descargar video</a>`;
                    mediaWrapper.appendChild(videoDownload);
                    break;
                case "audio":
                    const audio = document.createElement("audio");
                    audio.controls = true;
                    audio.className = "audio-player";
                    const audioSource = document.createElement("source");
                    audioSource.src = msg.media_url;
                    audio.appendChild(audioSource);
                    mediaWrapper.appendChild(audio);
                    const audioDownload = document.createElement("div");
                    audioDownload.innerHTML = `<a href="${msg.media_url}" target="_blank" rel="noopener" download>Descargar audio</a>`;
                    mediaWrapper.appendChild(audioDownload);
                    break;
                default:
                    const chip = document.createElement("div");
                    chip.className = "attachment-chip";
                    chip.innerHTML = `<i class="fas fa-paperclip"></i> <a href="${msg.media_url}" target="_blank" rel="noopener" download>Descargar archivo</a>`;
                    mediaWrapper.appendChild(chip);
                    break;
            }

            container.appendChild(mediaWrapper);
        }
    }

    function appendMessage(msg) {
        const bubble = document.createElement("div");
        bubble.className = "message-bubble " + (msg.sender_type === "agent" ? "message-agent" : "message-customer");

        const meta = document.createElement("div");
        meta.className = "message-meta";

        const badge = document.createElement("span");
        badge.className = "badge " + (msg.sender_type === "agent" ? "bg-primary" : "bg-success");
        badge.textContent = msg.sender_type === "agent" ? "Tú" : contactLabel;

        const timestamp = document.createElement("small");
        timestamp.className = "text-muted";
        timestamp.textContent = msg.sent_at_human;

        meta.appendChild(badge);
        meta.appendChild(timestamp);
        bubble.appendChild(meta);

        const content = document.createElement("div");
        content.className = "message-content";

        buildMediaContent(content, msg);

        if (msg.message_text) {
            const text = document.createElement("div");
            text.className = "message-text";
            text.textContent = msg.message_text;
            content.appendChild(text);
        }

        bubble.appendChild(content);
        thread.appendChild(bubble);
        thread.scrollTop = thread.scrollHeight;
    }

    function fetchMessages() {
        const url = new URL(fetchUrl, window.location.origin);
        url.searchParams.set("after_id", lastId);
        url.searchParams.set("mark_read", "1");

        fetch(url)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Error al actualizar la conversación");
                }
                return response.json();
            })
            .then((payload) => {
                if (Array.isArray(payload.messages) && payload.messages.length > 0) {
                    payload.messages.forEach((message) => {
                        appendMessage(message);
                        lastId = Math.max(lastId, message.id);
                    });
                    thread.dataset.lastId = String(lastId);
                }
                if (payload.updated_at_human && updatedLabel) {
                    updatedLabel.textContent = "Última actualización: " + payload.updated_at_human;
                }
            })
            .catch((error) => {
                console.error(error);
            });
    }

    setInterval(fetchMessages, 5000);

    const form = document.getElementById("message-form");
    const textarea = document.getElementById("message-input");

    if (form && textarea) {
        textarea.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                form.requestSubmit();
            }
        });
    }

    const refreshBtn = document.getElementById("refresh-messages");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            fetchMessages();
        });
    }
})();
</script>
{% endblock %}
