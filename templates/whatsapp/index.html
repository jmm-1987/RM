{% extends "base.html" %}

{% block title %}WhatsApp{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='whatsapp.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4 header-actions">
    <div>
        <h1 class="h3 mb-1 fw-bold">Bandeja de WhatsApp</h1>
        <p class="text-muted mb-0">Gestiona tus conversaciones y contactos en tiempo real</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('whatsapp_new_conversation') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Nueva conversación
        </a>
        <button class="btn btn-outline-success" type="button" id="refresh-conversations">
            <i class="fas fa-sync-alt"></i> Refrescar
        </button>
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#contactsModal">
            <i class="fas fa-address-book"></i> Contactos
        </button>
    </div>
</div>

<div class="modal fade" id="contactsModal" tabindex="-1" aria-labelledby="contactsModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" style="z-index: 1056;">
        <div class="modal-content" style="z-index: 1057; position: relative;">
            <div class="modal-header" style="pointer-events: auto;">
                <h5 class="modal-title" id="contactsModalLabel">Contactos guardados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" style="pointer-events: auto;"></button>
            </div>
            <div class="modal-body" style="pointer-events: auto;">
                <div class="mb-3 d-none" id="contacts-search-wrapper">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="search" class="form-control" id="contacts-search" placeholder="Buscar contacto...">
                    </div>
                </div>
                <div id="contacts-loading" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <div id="contacts-error" class="alert alert-danger d-none"></div>
                <div id="contacts-table-wrapper" class="table-responsive d-none">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th scope="col">Nombre</th>
                                <th scope="col">Chat ID</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Buscador de conversaciones -->
<div class="mb-3">
    <div class="input-group mb-2">
        <span class="input-group-text" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff;">
            <i class="fas fa-search"></i>
        </span>
        <input 
            type="search" 
            class="form-control" 
            id="conversation-search" 
            placeholder="Buscar conversación por nombre del cliente..." 
            autocomplete="off"
            style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff;"
        >
        <button 
            class="btn btn-outline-secondary" 
            type="button" 
            id="clear-search"
            style="border-color: rgba(255, 255, 255, 0.2); color: #fff; display: none;"
        >
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="form-check">
        <input 
            class="form-check-input" 
            type="checkbox" 
            id="filter-unread" 
            style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);"
        >
        <label class="form-check-label" for="filter-unread" style="color: #fff; cursor: pointer;">
            <i class="fas fa-envelope"></i> Mostrar solo conversaciones con mensajes no leídos
        </label>
    </div>
</div>

<div id="conversation-list-wrapper" class="{% if not conversaciones %}d-none{% endif %}">
    <div id="conversation-list" class="conversation-grid">
        {% for conversation in conversaciones %}
            {% set last = conversation.last_message() %}
            {% set unread = conversation.unread_count() %}
            <a class="conversation-tile" href="{{ url_for('whatsapp_conversation_detail', conversation_id=conversation.id) }}">
                <div class="tile-header d-flex justify-content-between align-items-center">
                    <div class="tile-name">{{ conversation.contact_name or conversation.contact_number|chat_display }}</div>
                    <div class="d-flex align-items-center gap-2">
                        {% set last_agent = conversation.last_agent_message() %}
                        {% if last_agent and last_agent.usuario %}
                            <span class="badge" style="background-color: {{ last_agent.usuario.color or '#007bff' }}; color: white; font-size: 0.75rem;">
                                <i class="fas fa-user"></i> {{ last_agent.usuario.username }}
                            </span>
                        {% endif %}
                        <div class="tile-meta">
                            {{ (conversation.updated_at | local_time).strftime("%d/%m/%Y %H:%M") if conversation.updated_at else "" }}
                        </div>
                    </div>
                </div>
                <div class="tile-snippet">
                    {% if last %}
                        {% if last.sender_type == 'agent' %}
                            {% if last.usuario %}
                                {% set prefix = last.usuario.username ~ ':' %}
                            {% else %}
                                {% set prefix = 'Sistema:' %}
                            {% endif %}
                        {% else %}
                            {% set prefix = (conversation.contact_name or conversation.contact_number|chat_display) ~ ':' %}
                        {% endif %}
                        {% if last.message_text %}
                            {{ prefix }} {{ last.message_text }}
                        {% elif last.media_type %}
                            {{ prefix }} [{{ last.media_type|title }}]
                        {% else %}
                            {{ prefix }} Mensaje
                        {% endif %}
                    {% else %}
                        Sin mensajes todavía
                    {% endif %}
                </div>
                {% if unread %}
                <div class="tile-footer mt-2">
                    <span class="badge bg-danger">{{ unread }} sin leer</span>
                </div>
                {% endif %}
            </a>
        {% endfor %}
    </div>
</div>

<div id="conversation-empty" class="empty-state {% if conversaciones %}d-none{% endif %}">
    <i class="fab fa-whatsapp fa-3x text-success mb-3"></i>
    <h5 class="fw-semibold mb-2">Aún no hay conversaciones</h5>
    <p class="text-muted mb-3">Inicia una conversación con el botón verde o espera a que llegue un nuevo mensaje.</p>
    <a href="{{ url_for('whatsapp_new_conversation') }}" class="btn btn-success">
        <i class="fas fa-plus"></i> Nueva conversación
    </a>
</div>

<script>
(function() {
    const listWrapper = document.getElementById("conversation-list-wrapper");
    const listElement = document.getElementById("conversation-list");
    const emptyAlert = document.getElementById("conversation-empty");
    const searchInput = document.getElementById("conversation-search");
    const clearSearchBtn = document.getElementById("clear-search");
    const filterUnreadCheckbox = document.getElementById("filter-unread");
    
    let allConversations = []; // Almacenar todas las conversaciones para filtrar

        if (!listElement) {
        return;
    }

    const apiUrl = "{{ url_for('whatsapp_api_conversations') }}";

    function renderConversations(items) {
        if (!items.length) {
            if (listWrapper) {
                listWrapper.classList.add("d-none");
            }
            if (emptyAlert) {
                emptyAlert.classList.remove("d-none");
            }
            listElement.innerHTML = "";
            return;
        }

        if (listWrapper) {
            listWrapper.classList.remove("d-none");
        }
        if (emptyAlert) {
            emptyAlert.classList.add("d-none");
        }

        listElement.innerHTML = "";

        items.forEach((item) => {
            const link = document.createElement("a");
            link.className = "conversation-tile";
            link.href = item.url;

            const header = document.createElement("div");
            header.className = "tile-header d-flex justify-content-between align-items-center";

            const name = document.createElement("div");
            name.className = "tile-name";
            name.textContent = item.display_name;

            const rightSide = document.createElement("div");
            rightSide.className = "d-flex align-items-center gap-2";

            // Añadir badge del último usuario del sistema que habló (siempre mostrar, incluso si el último mensaje es del cliente)
            if (item.last_usuario) {
                const userBadge = document.createElement("span");
                userBadge.className = "badge";
                // Usar el color del usuario directamente de su ficha
                userBadge.style.backgroundColor = item.last_usuario.color || "#007bff";
                userBadge.style.color = "white";
                userBadge.style.fontSize = "0.75rem";
                userBadge.innerHTML = `<i class="fas fa-user"></i> ${item.last_usuario.username}`;
                rightSide.appendChild(userBadge);
            }

            const meta = document.createElement("div");
            meta.className = "tile-meta";
            meta.textContent = item.updated_at_human || "";
            rightSide.appendChild(meta);

            header.appendChild(name);
            header.appendChild(rightSide);

            const snippet = document.createElement("div");
            snippet.className = "tile-snippet";

            const prefix = item.last_message_sender === "agent"
                ? (item.last_usuario ? item.last_usuario.username + ": " : "Sistema: ")
                : `${item.display_name}: `;

            if (item.last_message_text) {
                snippet.textContent = prefix + item.last_message_text;
            } else if (item.last_media_type) {
                const mediaLabels = {
                    imagen: "[Imagen]",
                    video: "[Video]",
                    audio: "[Audio]",
                    documento: "[Documento]",
                    adjunto: "[Adjunto]"
                };
                snippet.textContent = prefix + (mediaLabels[item.last_media_type] || "[Contenido multimedia]");
            } else {
                snippet.textContent = "Sin mensajes todavía";
            }

            link.appendChild(header);
            link.appendChild(snippet);

            // Añadir badge de mensajes sin leer si hay
            if (item.unread_count) {
                const footer = document.createElement("div");
                footer.className = "tile-footer mt-2";
                const unreadBadge = document.createElement("span");
                unreadBadge.className = "badge bg-danger";
                unreadBadge.textContent = `${item.unread_count} sin leer`;
                footer.appendChild(unreadBadge);
                link.appendChild(footer);
            }

            listElement.appendChild(link);
        });
    }

    function fetchConversations() {
        fetch(apiUrl)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("No fue posible actualizar la bandeja");
                }
                return response.json();
            })
            .then((payload) => {
                if (Array.isArray(payload.conversations)) {
                    allConversations = payload.conversations; // Guardar todas las conversaciones
                    filterConversations(); // Aplicar filtro si hay búsqueda activa
                }
            })
            .catch((error) => console.error(error));
    }

    function filterConversations() {
        let filtered = allConversations;
        
        // Filtrar por término de búsqueda
        if (searchInput) {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Mostrar/ocultar botón de limpiar búsqueda
            if (searchTerm) {
                clearSearchBtn.style.display = 'block';
            } else {
                clearSearchBtn.style.display = 'none';
            }
            
            if (searchTerm) {
                // Filtrar conversaciones por nombre del cliente
                filtered = filtered.filter(conversation => {
                    const displayName = (conversation.display_name || '').toLowerCase();
                    return displayName.includes(searchTerm);
                });
            }
        }
        
        // Filtrar por mensajes no leídos si el checkbox está activado
        if (filterUnreadCheckbox && filterUnreadCheckbox.checked) {
            filtered = filtered.filter(conversation => {
                return conversation.unread_count && conversation.unread_count > 0;
            });
        }
        
        renderConversations(filtered);
    }

    // Búsqueda dinámica mientras el usuario escribe
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterConversations();
        });
        
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchInput.value = '';
                filterConversations();
                searchInput.blur();
            }
        });
    }

    // Botón para limpiar búsqueda
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            if (searchInput) {
                searchInput.value = '';
                filterConversations();
                searchInput.focus();
            }
        });
    }

    // Checkbox para filtrar solo no leídos
    if (filterUnreadCheckbox) {
        filterUnreadCheckbox.addEventListener('change', function() {
            filterConversations();
        });
    }

    setInterval(fetchConversations, 5000);
    const refreshBtn = document.getElementById("refresh-conversations");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            fetchConversations();
        });
    }

    const contactsModal = document.getElementById("contactsModal");
    if (!contactsModal) {
        return;
    }

    const contactsLoading = document.getElementById("contacts-loading");
    const contactsError = document.getElementById("contacts-error");
    const contactsWrapper = document.getElementById("contacts-table-wrapper");
    const contactsTableBody = document.getElementById("contacts-table-body");
    const contactsSearchWrapper = document.getElementById("contacts-search-wrapper");
    const contactsSearch = document.getElementById("contacts-search");
    let cachedContacts = [];

    function renderContacts(contacts) {
        contactsTableBody.innerHTML = "";

        if (!contacts.length) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 4;
            cell.className = "text-center text-muted";
            cell.textContent = "Twilio no proporciona una API de contactos. Los contactos se gestionan desde la base de datos de clientes.";
            row.appendChild(cell);
            contactsTableBody.appendChild(row);
            return;
        }

        contacts.forEach((contact) => {
            const row = document.createElement("tr");

            const nameCell = document.createElement("td");
            nameCell.textContent = (contact.name || "").trim() || contact.chat_id || "Sin nombre";

            const idCell = document.createElement("td");
            idCell.textContent = contact.chat_id || "";

            const typeCell = document.createElement("td");
            typeCell.textContent = contact.type || "-";

            const actionsCell = document.createElement("td");
            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn btn-sm btn-outline-success";
            button.textContent = "Abrir";
            button.addEventListener("click", () => {
                const phone = contact.chat_id ? contact.chat_id.replace(/@.*/, "") : "";
                if (phone) {
                    window.location.href = "{{ url_for('whatsapp_new_conversation') }}" + "?number=" + encodeURIComponent(phone);
                } else {
                    alert("No se puede iniciar conversación: falta el chatId");
                }
            });
            actionsCell.appendChild(button);

            row.appendChild(nameCell);
            row.appendChild(idCell);
            row.appendChild(typeCell);
            row.appendChild(actionsCell);

            contactsTableBody.appendChild(row);
        });
    }

    contactsModal.addEventListener("show.bs.modal", function () {
        contactsLoading.classList.remove("d-none");
        contactsError.classList.add("d-none");
        contactsWrapper.classList.add("d-none");
            contactsSearchWrapper.classList.add("d-none");
            contactsSearch.value = "";
            cachedContacts = [];

        fetch("{{ url_for('whatsapp_api_contacts') }}")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("No se pudo obtener la lista de contactos");
                }
                return response.json();
            })
            .then((payload) => {
                cachedContacts = Array.isArray(payload.contacts) ? payload.contacts : [];
                renderContacts(cachedContacts);
                contactsWrapper.classList.remove("d-none");
                contactsSearchWrapper.classList.remove("d-none");
            })
            .catch((error) => {
                contactsError.textContent = error.message;
                contactsError.classList.remove("d-none");
            })
            .finally(() => {
                contactsLoading.classList.add("d-none");
            });
    });

    if (contactsSearch) {
        contactsSearch.addEventListener("input", function () {
            const term = this.value.toLowerCase().trim();
            if (!term) {
                renderContacts(cachedContacts);
                return;
            }

            const filtered = cachedContacts.filter(contact => {
                const name = (contact.name || "").toLowerCase();
                const chatId = (contact.chat_id || "").toLowerCase();
                return name.includes(term) || chatId.includes(term);
            });

            renderContacts(filtered);
        });
    }
})();
</script>
{% endblock %}

