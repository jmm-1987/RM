{% extends "base.html" %}

{% block title %}WhatsApp Web - Recambios RM{% endblock %}

{% block extra_head %}
<style>
    .whatsapp-container {
        height: 80vh;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .chat-sidebar {
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        height: 100%;
        overflow-y: auto;
    }
    
    .chat-main {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: #075e54;
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #e5ddd5;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="%23ffffff" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="%23ffffff" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    }
    
    .chat-input {
        background: white;
        padding: 15px;
        border-top: 1px solid #ddd;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        margin-bottom: 10px;
        word-wrap: break-word;
    }
    
    .message-sent {
        background: #dcf8c6;
        margin-left: auto;
        text-align: right;
    }
    
    .message-received {
        background: white;
        margin-right: auto;
    }
    
    .contact-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .contact-item:hover {
        background-color: #f0f0f0;
    }
    
    .contact-item.active {
        background-color: #e7f3ff;
        border-left: 3px solid #25d366;
    }
    
    .contact-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #25d366;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }
    
    .unread-badge {
        background: #25d366;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fab fa-whatsapp text-success"></i> WhatsApp Web - Recambios RM</h2>
                <div>
                    <button class="btn btn-success" onclick="recargarMensajes()">
                        <i class="fas fa-sync-alt"></i> Recargar Mensajes
                    </button>
                    <a href="{{ url_for('mensajes_recibidos') }}" class="btn btn-outline-primary">
                        <i class="fas fa-inbox"></i> Ver Todos
                    </a>
                </div>
            </div>

            <div class="whatsapp-container">
                <div class="row h-100">
                    <!-- Sidebar con contactos -->
                    <div class="col-md-4 p-0">
                        <div class="chat-sidebar">
                            <div class="p-3 border-bottom">
                                <h5 class="mb-0">Conversaciones</h5>
                                <small class="text-muted">Mensajes recibidos</small>
                            </div>
                            <div id="contactos-lista">
                                <!-- Los contactos se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Área principal de chat -->
                    <div class="col-md-8 p-0">
                        <div class="chat-main">
                            <!-- Header del chat -->
                            <div class="chat-header">
                                <div class="d-flex align-items-center">
                                    <div class="contact-avatar me-3" id="avatar-contacto">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" id="nombre-contacto">Selecciona una conversación</h6>
                                        <small id="telefono-contacto"></small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mensajes -->
                            <div class="chat-messages" id="mensajes-container">
                                <div class="text-center text-muted py-5">
                                    <i class="fab fa-whatsapp fa-3x mb-3"></i>
                                    <h5>Selecciona una conversación para comenzar</h5>
                                    <p>Los mensajes aparecerán aquí</p>
                                </div>
                            </div>
                            
                            <!-- Input para enviar mensajes -->
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="mensaje-input" 
                                           placeholder="Escribe un mensaje..." disabled>
                                    <button class="btn btn-success" id="enviar-btn" disabled onclick="enviarMensaje()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let contactoActual = null;
let mensajesInterval = null;

// Cargar contactos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarContactos();
    
    // Recargar mensajes cada 10 segundos
    mensajesInterval = setInterval(function() {
        if (contactoActual) {
            cargarMensajes(contactoActual);
        }
    }, 10000);
});

function cargarContactos() {
    fetch('/api/conversaciones')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('contactos-lista');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-muted">No hay conversaciones</div>';
                return;
            }
            
            data.forEach(contacto => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => seleccionarContacto(contacto);
                
                const inicial = contacto.nombre ? contacto.nombre.charAt(0).toUpperCase() : contacto.telefono.charAt(0);
                
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="contact-avatar me-3">${inicial}</div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${contacto.nombre || contacto.telefono}</h6>
                            <small class="text-muted">${contacto.telefono}</small>
                            <div class="mt-1">
                                <small class="text-muted">${contacto.ultimo_mensaje}</small>
                            </div>
                        </div>
                        ${contacto.no_leidos > 0 ? `<div class="unread-badge">${contacto.no_leidos}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        })
        .catch(error => {
            console.error('Error cargando contactos:', error);
        });
}

function seleccionarContacto(contacto) {
    contactoActual = contacto;
    
    // Actualizar UI
    document.querySelectorAll('.contact-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Actualizar header
    document.getElementById('nombre-contacto').textContent = contacto.nombre || contacto.telefono;
    document.getElementById('telefono-contacto').textContent = contacto.telefono;
    
    const inicial = contacto.nombre ? contacto.nombre.charAt(0).toUpperCase() : contacto.telefono.charAt(0);
    document.getElementById('avatar-contacto').textContent = inicial;
    
    // Habilitar input
    document.getElementById('mensaje-input').disabled = false;
    document.getElementById('enviar-btn').disabled = false;
    
    // Cargar mensajes
    cargarMensajes(contacto);
}

function cargarMensajes(contacto) {
    fetch(`/api/mensajes/${contacto.telefono}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('mensajes-container');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">No hay mensajes en esta conversación</div>';
                return;
            }
            
            data.forEach(mensaje => {
                const div = document.createElement('div');
                div.className = `message-bubble ${mensaje.tipo === 'enviado' ? 'message-sent' : 'message-received'}`;
                
                const fecha = new Date(mensaje.fecha).toLocaleString();
                
                div.innerHTML = `
                    <div>${mensaje.mensaje}</div>
                    <small class="text-muted">${fecha}</small>
                `;
                
                container.appendChild(div);
            });
            
            // Scroll al final
            container.scrollTop = container.scrollHeight;
        })
        .catch(error => {
            console.error('Error cargando mensajes:', error);
        });
}

function enviarMensaje() {
    const input = document.getElementById('mensaje-input');
    const mensaje = input.value.trim();
    
    if (!mensaje || !contactoActual) return;
    
    fetch(`/mensajes-recibidos/${contactoActual.id}/responder`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `respuesta=${encodeURIComponent(mensaje)}`
    })
    .then(response => {
        if (response.ok) {
            input.value = '';
            cargarMensajes(contactoActual);
            cargarContactos(); // Recargar lista para actualizar contadores
        } else {
            alert('Error enviando mensaje');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error enviando mensaje');
    });
}

function recargarMensajes() {
    if (contactoActual) {
        cargarMensajes(contactoActual);
    }
    cargarContactos();
}

// Enviar mensaje con Enter
document.getElementById('mensaje-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        enviarMensaje();
    }
});

// Limpiar interval al salir
window.addEventListener('beforeunload', function() {
    if (mensajesInterval) {
        clearInterval(mensajesInterval);
    }
});
</script>
{% endblock %}
